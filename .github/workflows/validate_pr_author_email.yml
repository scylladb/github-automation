name: validate PR author email

on:
  workflow_call:

jobs:
  validate_author_email:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Validate author emails
        id: validate
        run: |
          
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Checking commits from $BASE_SHA to $HEAD_SHA"
          
          # Get all commits in the PR
          COMMITS=$(git log --format="%H" $BASE_SHA..$HEAD_SHA)
          
          if [ -z "$COMMITS" ]; then
            echo "No commits found in PR"
            exit 0
          fi
          
          INVALID_COMMITS=""
          INVALID_COUNT=0
          
          # Check each commit's author and committer emails
          while IFS= read -r commit; do
            AUTHOR_EMAIL=$(git log -1 --format="%ae" $commit)
            COMMITTER_EMAIL=$(git log -1 --format="%ce" $commit)
            COMMIT_MSG=$(git log -1 --format="%s" $commit)
            
            # Skip GitHub Actions commits
            if [[ "$COMMITTER_EMAIL" == "action@github.com" ]]; then
              continue
            fi

            # Skip GitHub Copilot commits (includes noreply addresses used by Copilot and co-authored commits)
            if [[ "$COMMITTER_EMAIL" == *"noreply@github.com"* ]] || [[ "$COMMITTER_EMAIL" == "copilot@github.com" ]] || [[ "$COMMITTER_EMAIL" == "notification@github.com" ]] || [[ "$AUTHOR_EMAIL" == *"noreply@github.com"* ]]; then
              continue
            fi
            
            INVALID=""
            
            if [[ ! "$AUTHOR_EMAIL" =~ @scylladb\.com$ ]]; then
              INVALID="${INVALID}Author: $AUTHOR_EMAIL"
            fi
            
            if [[ ! "$COMMITTER_EMAIL" =~ @scylladb\.com$ ]]; then
              if [ -n "$INVALID" ]; then
                INVALID="${INVALID}, "
              fi
              INVALID="${INVALID} Committer: $COMMITTER_EMAIL"
            fi
            
            if [ -n "$INVALID" ]; then
              INVALID_COUNT=$((INVALID_COUNT + 1))
              INVALID_COMMITS="${INVALID_COMMITS}
          - **Commit:** \`${commit:0:8}\` - ${COMMIT_MSG}
            **Invalid emails:** ${INVALID}"
            fi
          done <<< "$COMMITS"
          
          # Save results for comment step
          echo "invalid_count=$INVALID_COUNT" >> $GITHUB_OUTPUT
          
          if [ $INVALID_COUNT -gt 0 ]; then
            echo "found_invalid=true" >> $GITHUB_OUTPUT
            # Build comment body using heredoc
            cat >> $GITHUB_OUTPUT <<'EOF'
          comment_body<<EOFCOMMENT
          ## ⚠️ Non-@scylladb.com Email Addresses Detected
          
          Found commit(s) with author or committer emails that don't end with `@scylladb.com`.
          
          This indicates either:
          - An external contributor (acceptable, but maintainer should be aware)
          - A developer who hasn't configured their git email correctly
          
          ### For ScyllaDB developers:
          If you're a ScyllaDB employee, please configure your git email globally:
          ```bash
          git config --global user.email "your.name@scylladb.com"
          ```
          
          If only your most recent commit is invalid, you can amend it:
          ```bash
          git commit --amend --reset-author --no-edit
          git push --force
          ```
          
          If you have **multiple invalid commits**, you need to rewrite them all:
          ```bash
          git rebase -i <base-commit>
          # Mark each invalid commit as 'edit', then for each:
          git commit --amend --reset-author --no-edit
          git rebase --continue
          # Repeat for each invalid commit
          git push --force
          ```
          EOFCOMMENT
          EOF
            exit 1
          else
            echo "found_invalid=false" >> $GITHUB_OUTPUT
            echo "✅ All commits have valid @scylladb.com email addresses"
            exit 0
          fi

      - name: Post comment on PR
        if: failure() && steps.validate.outputs.found_invalid == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.validate.outputs.comment_body }}

      - name: Set commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.validate.outcome }}' === 'success' ? 'success' : 'failure';
            const invalid_count = '${{ steps.validate.outputs.invalid_count }}';
            
            let description;
            if (state === 'success') {
              description = 'All commits have valid @scylladb.com emails';
            } else {
              description = `Found commit(s) with non-@scylladb.com emails`;
            }
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.pull_request.head.sha }}',
              state: state,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'validate-commit-emails'
            });
