name: Add Comment to Jira Issue

on:
  workflow_call:
    inputs:
      jira_key:
        description: "The Jira issue key (e.g. STAG-17)"
        required: true
        type: string
      comment:
        description: "The comment text to add to the issue"
        required: true
        type: string
    secrets:
      jira_auth:
        description: 'Plain "email:api_token" for Jira Cloud Basic auth'
        required: true

jobs:
  add_comment:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: https://scylladb.atlassian.net
      JIRA_KEY: ${{ inputs.jira_key }}
      COMMENT_RAW: ${{ inputs.comment }}
      JIRA_AUTH: ${{ secrets.jira_auth }}

    steps:
    - name: Post comment to Jira issue
    shell: bash
    run: |
      set -euo pipefail

      if [ -z "$JIRA_KEY" ]; then
        echo "JIRA_KEY is empty; nothing to do."
        exit 0
      fi

      # Build title + URL from PR context
      PR_TITLE="${{ github.event.pull_request.title }}"
      PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

      echo "Adding clickable comment to Jira issue: $JIRA_KEY"
      echo "PR title: $PR_TITLE"
      echo "PR URL  : $PR_URL"
  
      # ADF:
      # Closed via PR "<title-as-link>"
      PAYLOAD=$(jq -n \
        --arg prefix "Closed via PR " \
        --arg title "$PR_TITLE" \
        --arg url "$PR_URL" \
        '
        {
          body: {
            type: "doc",
            version: 1,
            content: [
              {
                type: "paragraph",
                content: [
                  { "type": "text", "text": $prefix },
                  {
                    "type": "text",
                    "text": ("\"" + $title + "\""),
                    "marks": [
                      { "type": "link", "attrs": { "href": $url } }
                    ]
                  }
                ]
              }
            ]
          }
        }
        ')
  
      echo "Payload to Jira:"
      echo "$PAYLOAD"
  
      ISSUE_URL="${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment"
  
      HTTP_CODE=$(curl -sS -w "%{http_code}" -o response.json \
        --user "$JIRA_AUTH" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -X POST "$ISSUE_URL" \
        --data "$PAYLOAD" || echo "000")
  
      echo "Jira HTTP status: $HTTP_CODE"
      echo "Jira response body:"
      cat response.json || true
  
      if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
        echo "Comment added to $JIRA_KEY"
      else
        echo "Failed to add comment to $JIRA_KEY (HTTP $HTTP_CODE)"
        exit 1
      fi
  
