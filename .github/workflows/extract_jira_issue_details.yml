name: Extract Jira Issue Details (CSV)

on:
  workflow_call:
    inputs:
      jira_keys_json:
        description: 'JSON array of Jira keys, e.g. ["PROJ-1","PROJ-2"]'
        required: true
        type: string
    secrets:
      jira_auth:
        description: 'Either "email:api_token" (Basic) or "Bearer <token>"'
        required: true
    outputs:
      csv:
        description: 'Full CSV content (header + rows)'
        value: ${{ jobs.build.outputs.csv }}
      csv_path:
        description: 'Path to CSV artifact (downloaded filename)'
        value: ${{ jobs.build.outputs.csv_path }}
      labels_csv:
        description: 'Deduped CSV of all labels across issues (no header)'
        value: ${{ jobs.build.outputs.labels_csv }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      csv:        ${{ steps.makecsv.outputs.csv }}
      csv_path:   ${{ steps.artifacts-out.outputs.csv_path }}
      labels_csv: ${{ steps.derive.outputs.labels_csv }}

    env:
      JIRA_BASE_URL: https://scylladb.atlassian.net
      SCYLLA_COMPONENTS_FIELD: customfield_10321
      DELIM: ";"

    steps:
      - name: Validate input keys
        id: validate
        shell: bash
        run: |
          keys='${{ inputs.jira_keys_json }}'
          if [ -z "$keys" ] || [ "$keys" = "[]" ] || [ "$keys" = '[""]' ]; then
            echo "empty_keys=true" >> "$GITHUB_OUTPUT"
          else
            echo "empty_keys=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Short-circuit on no keys
        if: ${{ steps.validate.outputs.empty_keys == 'true' }}
        id: makecsv-empty
        shell: bash
        run: |
          echo "csv=" >> "$GITHUB_OUTPUT"
          echo "labels_csv=" >> "$GITHUB_OUTPUT"
          printf "key,status,labels,assignee,priority,fixVersions,scylla_components\n" > jira-details.csv
          echo "csv_path=jira-details.csv" >> "$GITHUB_OUTPUT"

      - name: Query Jira (GET /search)
        if: ${{ steps.validate.outputs.empty_keys != 'true' }}
        id: query
        shell: bash
        env:
          BASE: ${{ env.JIRA_BASE_URL }}
          KEYS_JSON: ${{ inputs.jira_keys_json }}
          FIELD_ID: ${{ env.SCYLLA_COMPONENTS_FIELD }}
          JIRA_AUTH: ${{ secrets.jira_auth }}
        run: |
          set -euo pipefail
      
          echo "Using Basic auth (email:api_token)"
          echo "Jira Base: $BASE"
      
          # Build JQL and fields list
          keys_csv=$(jq -r 'join(",")' <<< "$KEYS_JSON")
          fields="status,labels,assignee,priority,fixVersions,${FIELD_ID}"
          jql="key in (${keys_csv})"
          echo "JQL: $jql"
          echo "Fields: $fields"
      
          # URL-encode JQL and fields safely
          enc_jql=$(python3 - <<'PY'
      import urllib.parse, os
      print(urllib.parse.quote(os.environ["JQL"]))
      PY
      JQL="$jql")
      
          enc_fields=$(python3 - <<'PY'
      import urllib.parse, os
      print(urllib.parse.quote(os.environ["FIELDS"]))
      PY
      FIELDS="$fields")
      
          # Build full GET URL
          url="${BASE%/}/rest/api/3/search?jql=${enc_jql}&fields=${enc_fields}&maxResults=1000"
      
          echo "Executing Jira GET search..."
          echo "Request URL: ${url}"
      
          # Perform GET with Basic authentication
          curl -sS --fail \
            --user "$JIRA_AUTH" \
            -H "Accept: application/json" \
            "$url" \
            -o search.json
      
          # Sanity check to confirm successful query
          issue_count=$(jq '.issues | length' search.json)
          echo "Fetched ${issue_count} Jira issues."


      - name: Build CSV
        if: ${{ steps.validate.outputs.empty_keys != 'true' }}
        id: makecsv
        shell: bash
        env:
          FIELD_ID: ${{ env.SCYLLA_COMPONENTS_FIELD }}
          DELIM: ${{ env.DELIM }}
        run: |
          set -euo pipefail
          printf "key,status,labels,assignee,priority,fixVersions,scylla_components\n" > jira-details.csv

          jq -r --arg delim "$DELIM" --arg field "$FIELD_ID" '
            def join_or_empty($d): if (.|length) > 0 then join($d) else "" end;

            .issues[]
            | {
                key: .key,
                status: (.fields.status.name // ""),
                labels: ((.fields.labels // []) | join_or_empty($delim)),
                assignee: (.fields.assignee.displayName // ""),
                priority: (.fields.priority.name // ""),
                fixVersions: ((.fields.fixVersions // []) | map(.name // "") | join_or_empty($delim)),
                scylla_components: (
                  (.fields[$field] // [])
                  | if type=="array" then
                      (map(.value // "") | join_or_empty($delim))
                    else
                      (tostring)
                    end
                )
              }
            | [.key, .status, .labels, .assignee, .priority, .fixVersions, .scylla_components]
            | @csv
          ' search.json >> jira-details.csv

          csv_content=$(cat jira-details.csv)
          echo "csv<<EOF" >> "$GITHUB_OUTPUT"
          echo "$csv_content" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Derive labels_csv
        if: ${{ steps.validate.outputs.empty_keys != 'true' }}
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          labels_csv=$(
            jq -r '
              [.issues[].fields.labels[]?]
              | map(tostring)
              | unique
              | join(",")
            ' search.json
          )
          echo "labels_csv=$labels_csv" >> "$GITHUB_OUTPUT"

      - name: Upload CSV artifact
        id: artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jira-details-csv
          path: jira-details.csv

      - name: Set csv_path output
        id: artifacts-out
        shell: bash
        run: |
          echo "csv_path=jira-details.csv" >> "$GITHUB_OUTPUT"
