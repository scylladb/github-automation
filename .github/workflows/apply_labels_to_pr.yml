name: Apply Labels to PR

on:
  workflow_call:
    inputs:
      pr_number:
        description: "Pull Request number to label"
        type: number
        required: true
      labels_csv:
        description: "Comma-separated labels string (e.g. 'bug, needs-triage, backend')"
        type: string
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare labels list (trim, dedupe, ignore empties)
        id: prepare
        env:
          LABELS_CSV: ${{ inputs.labels_csv }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          csv = os.environ.get("LABELS_CSV","")
          seen, out = set(), []
          for raw in csv.split(","):
              s = raw.strip()
              if s and s not in seen:
                  seen.add(s)
                  out.append(s)
          print("Parsed labels:", out)
          with open("labels.txt", "w", encoding="utf-8") as f:
              for l in out:
                  f.write(l + "\n")
          PY

      - name: Skip if no labels
        run: |
          if [ ! -s labels.txt ]; then
            echo "No labels to apply. Skipping."
            exit 0
          fi

      - name: Add labels (no pre-checks)
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          set -euo pipefail
          ISSUE_API="https://api.github.com/repos/${OWNER_REPO}/issues/${PR_NUMBER}/labels"

          while IFS= read -r LABEL || [ -n "$LABEL" ]; do
            LBL="$(echo "$LABEL" | awk '{$1=$1};1')"
            [ -z "$LBL" ] && continue

            echo "----------------------------------------"
            echo "Applying label: '${LBL}'"

            code=$(curl -sS -o /tmp/add_resp.json -w "%{http_code}" \
              -X POST "${ISSUE_API}" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json; charset=utf-8" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              --data "{\"labels\": [\"${LBL}\"]}" || true)

            if [ "${code}" = "200" ] || [ "${code}" = "201" ]; then
              echo "Result: success (HTTP ${code})."
            else
              echo "Result: failed (HTTP ${code}). Body (first 200 chars):"
              head -c 200 /tmp/add_resp.json || true
              echo
            fi
          done < labels.txt
