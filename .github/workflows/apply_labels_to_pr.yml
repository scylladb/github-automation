name: Apply Labels to PR

on:
  workflow_call:
    inputs:
      pr_number:
        description: "Pull Request number to label"
        type: number
        required: true
      labels_csv:
        description: "Comma-separated labels string (e.g. 'bug, needs-triage, backend')"
        type: string
        required: true
      details_csv:
        description: "Full CSV from Jira details (header + rows). Must include 'priority' and 'scylla_components' columns."
        type: string
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  apply_labels_to_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare labels list (trim, dedupe, ignore empties, compute P* & area/* from Jira)
        id: prepare
        env:
          LABELS_CSV:  ${{ inputs.labels_csv }}
          DETAILS_CSV: ${{ inputs.details_csv }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, io, csv, re

          pr_number   = os.environ.get("PR_NUMBER", "")
          labels_csv  = os.environ.get("LABELS_CSV", "")
          details_csv = os.environ.get("DETAILS_CSV", "")

          print("======================================================")
          print(" Apply Labels to PR — Input Parameters")
          print("======================================================")
          print(f"PR Number:       {pr_number}")
          print(f"labels_csv:      {labels_csv}")
          print("details_csv (first 5 lines):")
          print("------------------------------------------------------")
          for i, line in enumerate(details_csv.splitlines()):
              print(line)
              if i >= 4:
                  break
          print("------------------------------------------------------\n")

          # 1) Parse labels_csv into a deduped list
          raw_labels = [s.strip() for s in labels_csv.split(",")]
          seen = set()
          labels = []
          for s in raw_labels:
              if s and s not in seen:
                  seen.add(s)
                  labels.append(s)

          # 2) Remove any existing P0..P4 from this base list
          priority_labels = {"P0", "P1", "P2", "P3", "P4"}
          labels = [l for l in labels if l not in priority_labels]

          # 3) Prepare to compute Jira-based priority and area/* labels
          priority_rank_map = {
              "p0": 0, "highest": 0, "blocker": 0,
              "p1": 1, "critical": 1, "high": 1,
              "p2": 2, "medium": 2, "major": 2,
              "p3": 3, "low": 3, "minor": 3,
              "p4": 4, "lowest": 4, "trivial": 4,
          }

          best_rank = None
          area_labels = []
          area_seen = set()

          details_csv = details_csv.strip()
          if details_csv:
              reader = csv.DictReader(io.StringIO(details_csv))
              for row in reader:
                  # ----- priority → P* -----
                  prio = (row.get("priority") or "").strip()
                  if prio:
                      key = prio.lower()
                      rank = priority_rank_map.get(key)
                      if rank is not None:
                          if best_rank is None or rank < best_rank:
                              best_rank = rank

                  # ----- scylla_components → area/* labels -----
                  comp_raw = (row.get("scylla_components") or "").strip()
                  if comp_raw:
                      for part in comp_raw.split(";"):
                          comp = part.strip()
                          if not comp:
                              continue
                          safe = re.sub(r"\s+", "_", comp)
                          label = f"area/{safe}"
                          if label not in area_seen:
                              area_seen.add(label)
                              area_labels.append(label)

          # 4) Add computed P* label (if any) at the front
          priority_label = None
          if best_rank is not None:
              priority_label = f"P{best_rank}"

          if priority_label:
              print(f"Computed priority label from Jira: {priority_label}")
              if priority_label not in labels:
                  labels.insert(0, priority_label)
          else:
              print("No mappable Jira priority found; not adding P* label.")

          # 5) Append area/* labels (dedup vs other labels)
          for area in area_labels:
              if area not in labels:
                  labels.append(area)

          print("Final labels to apply:", labels)

          with open("labels.txt", "w", encoding="utf-8") as f:
              for l in labels:
                  f.write(l + "\n")
          PY

      - name: Skip if no labels
        run: |
          if [ ! -s labels.txt ]; then
            echo "No labels to apply. Skipping."
            exit 0
          fi

      - name: Remove existing P0–P4 labels from PR
        env:
          GH_TOKEN:   ${{ github.token }}
          OWNER_REPO: ${{ github.repository }}
          PR_NUMBER:  "${{ inputs.pr_number }}"
        run: |
          set -euo pipefail

          ISSUE_API_BASE="https://api.github.com/repos/${OWNER_REPO}/issues/${PR_NUMBER}"

          echo "Fetching existing labels for PR #${PR_NUMBER}..."
          curl -sS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${ISSUE_API_BASE}/labels" > /tmp/existing_labels.json

          jq -r '.[].name' /tmp/existing_labels.json > existing_labels.txt || true

          # Priority labels we *want* after normalization (from labels.txt)
          grep -E '^P[0-4]$' labels.txt > desired_p_labels.txt || true

          echo "Desired priority labels:"
          cat desired_p_labels.txt || true
          echo "Existing labels on PR:"
          cat existing_labels.txt || true

          # If we didn't compute any desired P* label, don't touch existing priorities
          if [ ! -s desired_p_labels.txt ]; then
            echo "No desired P* labels computed; keeping existing P* labels unchanged."
            exit 0
          fi

          for p in P0 P1 P2 P3 P4; do
            if grep -qx "$p" existing_labels.txt 2>/dev/null; then
              if grep -qx "$p" desired_p_labels.txt 2>/dev/null; then
                echo "Keeping existing priority label: $p (also desired)"
              else
                echo "Removing existing priority label not desired anymore: $p"
                code=$(curl -sS -o /tmp/del_resp.json -w "%{http_code}" \
                  -X DELETE "${ISSUE_API_BASE}/labels/${p}" \
                  -H "Authorization: Bearer ${GH_TOKEN}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" || true)
                echo "Delete $p → HTTP ${code}"
              fi
            fi
          done


      - name: Add labels (after priority & area/* normalization)
        env:
          GH_TOKEN:   ${{ github.token }}
          OWNER_REPO: ${{ github.repository }}
          PR_NUMBER:  "${{ inputs.pr_number }}"
        run: |
          set -euo pipefail
          ISSUE_API="https://api.github.com/repos/${OWNER_REPO}/issues/${PR_NUMBER}/labels"

          while IFS= read -r LABEL || [ -n "$LABEL" ]; do
            LBL="$(echo "$LABEL" | awk '{$1=$1};1')"
            [ -z "$LBL" ] && continue

            echo "----------------------------------------"
            echo "Applying label: '${LBL}'"

            code=$(curl -sS -o /tmp/add_resp.json -w "%{http_code}" \
              -X POST "${ISSUE_API}" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json; charset=utf-8" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              --data "{\"labels\": [\"${LBL}\"]}" || true)

            if [ "${code}" = "200" ] || [ "${code}" = "201" ]; then
              echo "Result: success (HTTP ${code})."
            else
              echo "Result: failed (HTTP ${code}). Body (first 200 chars):"
              head -c 200 /tmp/add_resp.json || true
              echo
            fi
          done < labels.txt
