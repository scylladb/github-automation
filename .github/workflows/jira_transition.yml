name: Jira Transition (from CSV)

on:
  workflow_call:
    inputs:
      # Full CSV text from the details job (header + rows).
      # Expected columns include: key,status,labels,assignee,priority,fixVersions,scylla_components
      details_csv:
        required: true
        type: string
      transition_name:
        required: true
        type: string
      transition_id:
        required: true
        type: string
    secrets:
      jira_auth:
        required: true

jobs:
  transition_jira_status:
    runs-on: ubuntu-slim
    env:
      JIRA_BASE_URL: https://scylladb.atlassian.net
      START_DATE_FIELD: customfield_10015
      DUE_DATE_FIELD: duedate

    steps:
      - name: Write CSV to file
        shell: bash
        run: |
          cat > details.csv <<'CSV_EOF'
          ${{ inputs.details_csv }}
          CSV_EOF
          echo "Wrote details.csv"
          head -n 5 details.csv || true

      - name: Plan transitions (parse CSV)
        id: plan
        shell: bash
        env:
          TARGET: ${{ inputs.transition_name }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import csv, sys, io, os
          
          target = os.environ['TARGET']
          to_transition = []   # list of (key, current_status)
          already_ok = []      # list of (key, current_status)
          done_issues = []     # list of (key, current_status == Done)
          
          with open('details.csv', newline='', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              # Normalize headers
              fieldmap = { (h or '').strip().lower(): h for h in reader.fieldnames or [] }
              def get(row, name):
                  h = fieldmap.get(name.lower())
                  return (row.get(h) or "").strip() if h else ""
          
              for row in reader:
                  key = get(row, 'key')
                  status = get(row, 'status')
                  start_date = get(row, 'startdate')
                  due_date = get(row, 'duedate')
                  if not key:
                      continue
          
                  # Skip already correct or Done issues
                  if status.lower() == target.lower():
                      already_ok.append((key, status))
                  elif status.lower() in {"done", "duplicate", "won't fix"}:
                      done_issues.append((key, status))
                  else:
                      to_transition.append((key, status, start_date, due_date))
          
          # Write plan files
          def write_list(fname, items):
              with open(fname, 'w', encoding='utf-8') as out:
                  for item in items:
                      if len(item) == 4:
                          k, s, sd, dd = item
                          out.write(f"{k}|{s}|{sd}|{dd}\n")
                      else:
                          k, s = item
                          out.write(f"{k}|{s}\n")
          
          write_list('to_transition.txt', to_transition)
          write_list('already_ok.txt', already_ok)
          write_list('done_issues.txt', done_issues)
          
          print(f"{len(to_transition)} need transition, {len(already_ok)} already OK, {len(done_issues)} are Done.", file=sys.stderr)
          PY

          echo "----- Already OK (up to 10) -----"
          head -n 10 already_ok.txt || true
          echo "----- Done issues (up to 10) -----"
          head -n 10 done_issues.txt || true
          echo "----- Need Transition (up to 10) -----"
          head -n 10 to_transition.txt || true

      - name: Show intent summary
        shell: bash
        env:
          TARGET: ${{ inputs.transition_name }}
        run: |
          need=$(wc -l < to_transition.txt 2>/dev/null || echo 0)
          ok=$(wc -l < already_ok.txt 2>/dev/null || echo 0)
          done=$(wc -l < done_issues.txt 2>/dev/null || echo 0)
          echo "Target status: ${TARGET}"
          echo "Issues already at target: ${ok}"
          echo "Issues in 'Done' state:  ${done}"
          echo "Issues to transition:     ${need}"

      - name: Transition issues
        if: ${{ always() }}
        shell: bash
        env:
          JIRA_AUTH: ${{ secrets.jira_auth }}
          TARGET: ${{ inputs.transition_name }}
          TRANSITION_ID: ${{ inputs.transition_id }}
          BASE: ${{ env.JIRA_BASE_URL }}
          START_DATE_FIELD: ${{ env.START_DATE_FIELD }}
          DUE_DATE_FIELD: ${{ env.DUE_DATE_FIELD }}
        run: |
          set -euo pipefail

          if [ ! -s to_transition.txt ]; then
            echo "No issues require transition. Done."
            exit 0
          fi

          if [ -z "${JIRA_AUTH:-}" ]; then
            echo "ERROR: jira_auth secret not set." >&2
            exit 1
          fi

          while IFS='|' read -r key current start_date due_date; do
            [ -n "${key:-}" ] || continue
            echo "Transitioning ${key} from '${current}' -> '${TARGET}' (id=${TRANSITION_ID})"

            # Check if transitioning to a working state and if start date needs to be set
            WORKING_STATES=("in progress" "in review" "ready for merge")
            SET_START_DATE=false
            for state in "${WORKING_STATES[@]}"; do
              if [[ "${TARGET,,}" == "$state" ]]; then
                SET_START_DATE=true
                break
              fi
            done

            # If transitioning to working state and start date is empty, set it
            if [ "$SET_START_DATE" = true ]; then
              if [ -z "$start_date" ] || [ "$start_date" = "null" ]; then
                TODAY=$(date -u +%Y-%m-%d)
                echo "Setting start date to ${TODAY} for ${key} (field: ${START_DATE_FIELD})"
                
                # Use custom field ID for start date
                if [[ "$JIRA_AUTH" == Bearer\ * ]]; then
                  RESPONSE=$(curl -sS -w "\n%{http_code}" -X PUT \
                    -H "Authorization: $JIRA_AUTH" \
                    -H "Accept: application/json" \
                    -H "Content-Type: application/json" \
                    --data "{\"fields\": {\"${START_DATE_FIELD}\": \"${TODAY}\"}}" \
                    "${BASE}/rest/api/3/issue/${key}" 2>&1)
                else
                  RESPONSE=$(curl -sS -w "\n%{http_code}" -X PUT \
                    --user "$JIRA_AUTH" \
                    -H "Accept: application/json" \
                    -H "Content-Type: application/json" \
                    --data "{\"fields\": {\"${START_DATE_FIELD}\": \"${TODAY}\"}}" \
                    "${BASE}/rest/api/3/issue/${key}" 2>&1)
                fi
                
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                if [ "$HTTP_CODE" != "204" ]; then
                  echo "Warning: Failed to set start date for ${key} (HTTP ${HTTP_CODE})" >&2
                  echo "$RESPONSE" | head -n-1 >&2
                fi
                sleep 0.2
              else
                echo "Start date already set for ${key}: ${start_date}"
              fi
            fi

            # Check if transitioning to a closed state and if due date needs to be set
            CLOSED_STATES=("done" "won't fix")
            SET_DUE_DATE=false
            for state in "${CLOSED_STATES[@]}"; do
              if [[ "${TARGET,,}" == "$state" ]]; then
                SET_DUE_DATE=true
                break
              fi
            done

            # If transitioning to closed state and due date is empty, set it
            if [ "$SET_DUE_DATE" = true ]; then
              if [ -z "$due_date" ] || [ "$due_date" = "null" ]; then
                TODAY=$(date -u +%Y-%m-%d)
                echo "Setting due date to ${TODAY} for ${key} (field: ${DUE_DATE_FIELD})"
                
                if [[ "$JIRA_AUTH" == Bearer\ * ]]; then
                  RESPONSE=$(curl -sS -w "\n%{http_code}" -X PUT \
                    -H "Authorization: $JIRA_AUTH" \
                    -H "Accept: application/json" \
                    -H "Content-Type: application/json" \
                    --data "{\"fields\": {\"${DUE_DATE_FIELD}\": \"${TODAY}\"}}" \
                    "${BASE}/rest/api/3/issue/${key}" 2>&1)
                else
                  RESPONSE=$(curl -sS -w "\n%{http_code}" -X PUT \
                    --user "$JIRA_AUTH" \
                    -H "Accept: application/json" \
                    -H "Content-Type: application/json" \
                    --data "{\"fields\": {\"${DUE_DATE_FIELD}\": \"${TODAY}\"}}" \
                    "${BASE}/rest/api/3/issue/${key}" 2>&1)
                fi
                
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                if [ "$HTTP_CODE" != "204" ]; then
                  echo "Warning: Failed to set due date for ${key} (HTTP ${HTTP_CODE})" >&2
                  echo "$RESPONSE" | head -n-1 >&2
                fi
                sleep 0.2
              else
                echo "Due date already set for ${key}: ${due_date}"
              fi
            fi

            if [[ "$JIRA_AUTH" == Bearer\ * ]]; then
              curl -sS --fail -X POST \
                -H "Authorization: $JIRA_AUTH" \
                -H "Accept: application/json" \
                -H "Content-Type: application/json" \
                --data "{\"transition\": {\"id\": \"${TRANSITION_ID}\"}}" \
                "${BASE}/rest/api/3/issue/${key}/transitions" \
                || { echo "Failed to transition ${key}" >&2; exit 1; }
            else
              curl -sS --fail -X POST \
                --user "$JIRA_AUTH" \
                -H "Accept: application/json" \
                -H "Content-Type: application/json" \
                --data "{\"transition\": {\"id\": \"${TRANSITION_ID}\"}}" \
                "${BASE}/rest/api/3/issue/${key}/transitions" \
                || { echo "Failed to transition ${key}" >&2; exit 1; }
            fi

            # Gentle rate limit
            sleep 0.2
          done < to_transition.txt
